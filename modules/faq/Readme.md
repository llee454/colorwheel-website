FAQ Readme
==========

The FAQ module works in conjunction with the Search module to provide an
interactive FAQ feature. Developers can create an XML file that defines
answers to common questions and then embed a search block that displays
these answers in response to questions. Additionally, queries and result
click events can be logged using the Analytics module.

```javascript
/*
  The FAQ module allows developers to define answer databases for common
  questions and embed search blocks that users can use to find answers to
  common questions.
*/

var faq_DATABASE_URL = 'modules/faq/database.xml';
```

The Load Event Handler
----------------------

The FAQ module loads a FAQ database file, and registers a Search module
search source that exposes the question answer pairs. These answers can be
included in search results generated by the Search module.

```javascript
/*
  Load the FAQ database file, parse the answers, and register a search source
  that provides the answers for inclusion in search results.
*/
MODULE_LOAD_HANDLERS.add (
  function (done) {
    // I. load and parse the FAQ database file.
    faq_loadDatabase (faq_DATABASE_URL,
      function (error, database) {
        if (error) { return done (error); }

        database.forEach (function (collection) {
          // II. register a search source that returns the FAQ answers.
          search_registerSource (collection.id, function (setId, done) {
            done (null, collection.entries);
          });
        })

        done (null);
    });
});
```

The Database Parser
-------------------

The FAQ database is defined by an XML file. The following two functions load and parse this file.

```javascript
/*
  Accepts two arguments:

  * databaseURL, a URL string
  * and done, a function that accepts two arguments: an Error object; and
  a faq_Database

  loads the database document at databaseURL, parses the document, and passes
  the resulting database object to done.

  If an error occurs, this function passes the error to done instead.
*/
function faq_loadDatabase (databaseURL, done) {
  $.get (databaseURL,
    function (databaseElement) {
      done (null, faq_parseDatabase (databaseElement));
    },
    'xml'
  )
  .fail (function () {
    var error = new Error ('[faq][faq_loadDatabase] Error: an error occured while trying to load "' + databaseURL + '".');
    strictError (error);
    done (error);
  });
}

/*
  Accepts one argument: databaseElement, a JQuery XML Document that represents
  a FAQ Database Document; and returns the database represented by the
  document as a faq_Database object.

  Note: a faq_Database is list of faq_Entry objects.
*/
function faq_parseDatabase (databaseElement) {
  var database = [];
  $('database > collection', databaseElement).each (
    function (i, collectionElement) {
      database.push (faq_parseCollection (collectionElement));
  });
  return database;
}

/*
  Accepts one argument: collectionElement, a JQuery XML Element that represents
  a collection of FAQ answers; and returns the faq_Collection represented by
  collectionElement.
*/
function faq_parseCollection (collectionElement) {
  var entries = [];
  $('collection > entries > entry', collectionElement).each (
    function (i, entryElement) {
      entries.push (faq_parseEntry (entryElement));
  });
  return new faq_Collection (
    $('collection > id', collectionElement).text (),
    entries);
}

/*
  Accepts one argument: entryElement, a JQuery XML Element that represents
  a FAQ answer; and returns the faq_Entry represented by entryElement.
*/
function faq_parseEntry (entryElement) {
  return new faq_Entry (
    $('> id', entryElement).text (),
    $('> title', entryElement).text (),
    $('> keywords', entryElement).text (),
    $('> url', entryElement).text (),
    $('> body', entryElement).text ());
}
```

The FAQ Database, Collection, and Entry Classes
----------------------------------

A FAQ Database is an array of faq_Collection objects which themselves label collection of faq_Entry objects. A faq_Entry object is an instance of the search_Entry class and represents the answer to a FAQ question. 

```javascript
/*
  Accepts two arguments:

  * id, a FAQ ID string
  * entries, an array of faq_Entry values
*/
function faq_Collection (id, entries) {
  this.id      = id;
  this.entries = entries;
}

faq_Collection.prototype = Object.create (faq_Collection.prototype);

/*
  Accepts five arguments:

  * id, a FAQ ID string
  * title, the title that will be displayed in the search result
  * keywords, a space delimited list of keywords that this answer will be returned for
  * url, an optional string linking to some resource
  * and body, an HTML string that represents the answer text
*/
function faq_Entry (id, title, keywords, url, body) {
  search_Entry.call (this, 'faq/' + id);
  this.title    = title;
  this.keywords = keywords;
  this.url      = url;
  this.body     = body;
}

faq_Entry.prototype = Object.create (faq_Entry.prototype);

/*
  Accepts two arguments:

  * query, the query string
  * and done, a function that accepts two arguments: an error object; and
    a JQuery HTML Element.

  creates an HTML element that represents this search entry and passes the
  element to done.
*/
faq_Entry.prototype.getResultElement = function (query, done) {
  var resultElement = this.url == '' ?
    $('<li></li>')
      .addClass ('search_result')
        .addClass ('search_result_link')
        .append ($('<h3></h3>').text (this.title))
        .append (this.body) :
    $('<li></li>')
      .addClass ('search_result')
      .append ($('<a></a>')
        .addClass ('search_result_link')
        .attr ('href', this.url)
        .on ('click', function () {
           ga ('send', 'event', 'faq search result', this.id);
         })
        .append ($('<h3></h3>').text (this.title))
        .append (this.body));


  done (null, resultElement);
}
```

Example FAQ Database
--------------------

FAQ databases are defined using XML documents. These documents list the question and answer pairs that comprise the FAQ. An example library document can be found here: [database.xml.example](#Example-FAQ-Database "save:").

```xml
<?xml version="1.0" encoding="utf-8" ?>
<database>
  <collection>
    <id>faq</id>
    <entries>
      <entry>
        <id>fact</id>
        <title>Example Fact</title>
        <keywords>example fact</keywords>
        <url></url>
        <body><![CDATA[This is an example fact]]></body>
      </entry>
    </entries>
  </collection>
</database>
```

The FAQ Database Schema
-----------------------

FAQ database documents must conform to the following XML schema. The schema can be found here: [database.xsd](#The-FAQ-Database-Schema "save:").

```xml
<?xml version="1.0" encoding="utf-8" ?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema">
  <!-- Defines the root element. -->
  <xs:element name="database">
    <xs:complexType>
      <xs:sequence>
        <xs:element name="collection" type="collectionType" minOccurs="0" maxOccurs="unbounded" />
      </xs:sequence>
    </xs:complexType>
  </xs:element>

  <!-- Defines the Collection type. -->
  <xs:complexType name="collectionType">
    <xs:sequence>
      <xs:element name="id" type="xs:string" minOccurs="1" maxOccurs="1" />
      <xs:element name="entry" type="entryType" minOccurs="0" maxOccurs="unbounded" />
    </xs:sequence>
  </xs:complexType>

  <!-- Defines the Entry type. -->
  <xs:complexType name="entryType">
    <xs:sequence>
      <xs:element name="id" type="xs:string" minOccurs="1" maxOccurs="1" />
      <xs:element name="title" type="xs:string" minOccurs="1" maxOccurs="1"/>
      <xs:element name="keywords" type="xs:string" minOccurs="1" maxOccurs="1" />
      <xs:element name="url" type="xs:anyURI" minOccurs="0" maxOccurs="1" />
      <xs:element name="body" type="xs:string" minOccurs="1" maxOccurs="1" />
    </xs:sequence>
  </xs:complexType>
</xs:schema>
```

Generating Source Files
-----------------------

You can generate the Curly module's source files using [Literate Programming](https://github.com/jostylr/literate-programming), simply execute:
`literate-programming Readme.md`
from the command line.

### Faq.js
```
_"FAQ Readme"

_"The Load Event Handler"

_"The Database Parser"

_"The FAQ Database and Entry Classes"
```
[faq.js](#Faq.js "save:")
